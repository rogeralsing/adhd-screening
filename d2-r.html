<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>d2-R Attention Test (Revised)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .game-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
            text-align: center;
            width: 100%;
            max-width: 900px;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .instructions,
        .results {
            font-size: 1.1em;
            margin-bottom: 25px;
            line-height: 1.6;
            color: #555;
            text-align: left;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .instructions p,
        .results p {
            margin: 5px 0;
        }

        .game-area {
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .symbol-row {
            display: flex;
            flex-wrap: wrap;
            /* Allow wrapping to multiple lines */
            justify-content: center;
            gap: 8px;
            /* Justerat gap för att få 10 per rad */
            margin-bottom: 20px;
            width: 100%;
            /* Fixerad bredd för att tvinga fram 10 per rad */
            max-width: 780px;
            /* 10 symboler * (45px bredd + 8px gap) - 8px för sista gapet = 520px. Vi vill ha utrymme */
            padding-bottom: 5px;
        }

        .symbol {
            font-size: 2em;
            /* Justerad fontstorlek för att passa */
            font-weight: bold;
            width: 50px;
            /* Justerad bredd för att passa */
            height: 60px;
            /* Justerad höjd för att passa */
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.1s ease, border-color 0.1s ease;
            position: relative;
            line-height: 1;
        }

        /* Specific styling for symbols in instructions */
        .instructions .symbol {
            cursor: default;
            border-color: #eee;
            background-color: #f0f0f0;
            font-size: 1.8em;
            width: 45px;
            height: 55px;
        }


        .symbol.selected {
            background-color: #d1e7dd;
            border-color: #28a745;
        }

        .symbol.correct {
            background-color: #d4edda;
            border-color: #28a745;
        }

        .symbol.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
        }

        .symbol .line-segment {
            font-size: 0.55em;
            font-weight: normal;
            height: 0.6em;
            overflow: hidden;
            line-height: 0.5;
            text-align: center;
        }

        .symbol .main-char {
            font-size: 1.2em;
            margin: 0;
        }

        .timer-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            height: 20px;
            margin-top: 20px;
            overflow: hidden;
        }

        .timer-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 100%;
            transition: width 0.9s linear;
        }

        .game-controls {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background-color 0.2s ease;
            font-weight: bold;
        }

        button#start-game-btn {
            background-color: #007bff;
            color: white;
        }

        button#start-game-btn:hover {
            background-color: #0056b3;
        }

        button#next-turn-btn {
            background-color: #6c757d;
            color: white;
        }

        button#next-turn-btn:hover {
            background-color: #5a6268;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            color: #666666;
        }

        .game-info {
            margin-top: 15px;
            font-size: 1.1em;
            color: #666;
        }

        .hidden {
            display: none;
        }

        #turn-config {
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #333;
        }

        #turn-config label {
            margin-right: 10px;
        }

        #turn-config input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            width: 60px;
            text-align: center;
        }

        .instruction-examples {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="game-container">
        <h1>d2-R Attention Test (Revised)</h1>

        <div class="instructions" id="instructions-panel">
            <p><strong>Instruktioner:</strong></p>
            <p>Din uppgift är att hitta och klicka på alla 'd'-symboler som har **EXAKT TVÅ linjer**. Linjerna kan vara
                ovanför, under, eller en ovanför och en under symbolen.</p>
            <p>Varje linje representeras av bokstaven "I". Så, en 'd'-symbol som är ett mål ser ut så här:</p>

            <div class="instruction-examples">
                <div class="symbol">
                    <div class="line-segment">I</div>
                    <div class="main-char">d</div>
                    <div class="line-segment">I</div>
                </div>
                <div class="symbol">
                    <div class="line-segment">II</div>
                    <div class="main-char">d</div>
                    <div class="line-segment"></div>
                </div>
                <div class="symbol">
                    <div class="line-segment"></div>
                    <div class="main-char">d</div>
                    <div class="line-segment">II</div>
                </div>
            </div>

            <p>Ignorera alla 'd'-symboler med en eller tre linjer, och alla 'p'-symboler oavsett antal linjer.</p>
            <p>Varje omgång varar i 20 sekunder. En progressbar visar hur mycket tid som återstår.</p>
            <p>Klicka på "Starta Spel" för att börja!</p>
        </div>

        <div id="turn-config">
            <label for="num-turns">Antal omgångar:</label>
            <input type="number" id="num-turns" value="14" min="1" max="25">
        </div>

        <div class="game-info hidden" id="game-info">
            <p>Omgång: <span id="current-turn">0</span> / <span id="total-turns">0</span></p>
        </div>

        <div class="game-area hidden" id="game-area">
            <div class="symbol-row" id="symbol-row">
            </div>
            <div class="timer-bar-container">
                <div class="timer-bar" id="timer-bar"></div>
            </div>
        </div>

        <div class="game-controls">
            <button id="start-game-btn">Starta Spel</button>
            <button id="next-turn-btn" class="hidden">Nästa Omgång</button>
        </div>

        <div class="results hidden" id="results-panel">
            <h2>Testresultat</h2>
            <p>Totalt korrekt markerade mål: <span id="total-correct">0</span></p>
            <p>Totalt felaktiga markeringar (kommissioner): <span id="total-incorrect">0</span></p>
            <p>Totalt missade mål (utelämnanden): <span id="total-omissions">0</span></p>
            <p>Noggrannhetspoäng: <span id="accuracy-score">0.00</span>%</p>
            <button onclick="location.reload()">Starta om testet</button>
        </div>
    </div>

    <script>
        const symbols = ['d', 'p'];
        const dashCounts = [1, 2, 3]; // Antal linjer
        const turnDuration = 20; // sekunder
        const symbolsPerTurn = 60; // Ändrat från 47 till 60

        // Ny konstant för att kontrollera frekvensen av målsymboler
        const targetFrequency = 0.349; // 34.9%

        let currentTurn = 0;
        let totalTurns = 0;
        let timerInterval;
        let timeLeft;
        let gameActive = false;

        let turnTargets = [];
        let turnSelections = new Set();
        let totalCorrectSelections = 0;
        let totalIncorrectSelections = 0;
        let totalOmissions = 0;

        const startButton = document.getElementById('start-game-btn');
        const nextTurnButton = document.getElementById('next-turn-btn');
        const symbolRow = document.getElementById('symbol-row');
        const timerBar = document.getElementById('timer-bar');
        const currentTurnSpan = document.getElementById('current-turn');
        const totalTurnsSpan = document.getElementById('total-turns');
        const gameArea = document.getElementById('game-area');
        const gameInfo = document.getElementById('game-info');
        const instructionsPanel = document.getElementById('instructions-panel');
        const resultsPanel = document.getElementById('results-panel');
        const numTurnsInput = document.getElementById('num-turns');
        const turnConfigDiv = document.getElementById('turn-config');

        // Resultatelement
        const totalCorrectSpan = document.getElementById('total-correct');
        const totalIncorrectSpan = document.getElementById('total-incorrect');
        const totalOmissionsSpan = document.getElementById('total-omissions');
        const accuracyScoreSpan = document.getElementById('accuracy-score');

        // Sätt defaultvärdet för antal omgångar till 14
        numTurnsInput.value = 14;


        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateLines(count) {
            return 'I'.repeat(count);
        }

        function generateSymbol() {
            let char;
            let topLinesCount = 0;
            let bottomLinesCount = 0;
            let totalLines;
            let isTarget;

            // Steg 1: Bestäm om det ska vara en målsymbol (d med 2 linjer)
            if (Math.random() < targetFrequency) {
                isTarget = true;
                char = 'd';
                totalLines = 2; // Måste ha exakt 2 linjer
                // Fördela de 2 linjerna slumpmässigt
                const distribution = getRandomInt(0, 2); // 0: 2 top, 0 bottom; 1: 1 top, 1 bottom; 2: 0 top, 2 bottom
                if (distribution === 0) { topLinesCount = 2; }
                else if (distribution === 1) { topLinesCount = 1; bottomLinesCount = 1; }
                else { bottomLinesCount = 2; }
            } else {
                // Steg 2: Om det INTE är en målsymbol, generera en icke-målsymbol
                isTarget = false;

                // Slumpa först vilken typ av icke-målsymbol det ska vara
                // En 'd' med 1 eller 3 linjer, eller en 'p' med 1, 2 eller 3 linjer
                const nonTargetType = getRandomInt(0, 1); // 0 för 'd', 1 för 'p'

                if (nonTargetType === 0) { // En 'd' som inte är ett mål
                    char = 'd';
                    // Måste ha 1 eller 3 linjer
                    totalLines = Math.random() < 0.5 ? 1 : 3;
                } else { // En 'p'
                    char = 'p';
                    // Kan ha 1, 2 eller 3 linjer
                    totalLines = dashCounts[getRandomInt(0, 2)];
                }

                // Fördela linjerna för icke-målsymboler
                if (totalLines === 1) {
                    if (Math.random() < 0.5) { topLinesCount = 1; }
                    else { bottomLinesCount = 1; }
                } else if (totalLines === 2) {
                    const distribution = getRandomInt(0, 2);
                    if (distribution === 0) { topLinesCount = 2; }
                    else if (distribution === 1) { topLinesCount = 1; bottomLinesCount = 1; }
                    else { bottomLinesCount = 2; }
                } else { // totalLines === 3
                    const distribution = getRandomInt(0, 3);
                    if (distribution === 0) { topLinesCount = 2; bottomLinesCount = 1; }
                    else if (distribution === 1) { topLinesCount = 1; bottomLinesCount = 2; }
                    else if (distribution === 2) { topLinesCount = 3; }
                    else { bottomLinesCount = 3; }
                }
            }
            return { char, topLinesCount, bottomLinesCount, isTarget };
        }

        function renderSymbolRow() {
            symbolRow.innerHTML = '';
            turnTargets = [];
            turnSelections = new Set();

            for (let i = 0; i < symbolsPerTurn; i++) {
                const { char, topLinesCount, bottomLinesCount, isTarget } = generateSymbol();
                const symbolDiv = document.createElement('div');
                symbolDiv.classList.add('symbol');
                symbolDiv.dataset.index = i;
                symbolDiv.dataset.isTarget = isTarget;

                const topLinesDiv = document.createElement('div');
                topLinesDiv.classList.add('line-segment');
                topLinesDiv.textContent = generateLines(topLinesCount);
                symbolDiv.appendChild(topLinesDiv);

                const charDiv = document.createElement('div');
                charDiv.classList.add('main-char');
                charDiv.textContent = char;
                symbolDiv.appendChild(charDiv);

                const bottomLinesDiv = document.createElement('div');
                bottomLinesDiv.classList.add('line-segment');
                bottomLinesDiv.textContent = generateLines(bottomLinesCount);
                symbolDiv.appendChild(bottomLinesDiv);

                symbolDiv.addEventListener('click', () => handleSymbolClick(symbolDiv, i));
                symbolRow.appendChild(symbolDiv);

                if (isTarget) {
                    turnTargets.push(i);
                }
            }
        }

        function handleSymbolClick(symbolDiv, index) {
            if (!gameActive) return;

            if (turnSelections.has(index)) {
                turnSelections.delete(index);
                symbolDiv.classList.remove('selected');
            } else {
                turnSelections.add(index);
                symbolDiv.classList.add('selected');
            }
        }

        function startTimer() {
            timeLeft = turnDuration;
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#4CAF50';

            timerInterval = setInterval(() => {
                timeLeft--;
                const percentage = (timeLeft / turnDuration) * 100;
                timerBar.style.width = `${percentage}%`;

                if (percentage <= 25) {
                    timerBar.style.backgroundColor = '#ffc107';
                }
                if (percentage <= 10) {
                    timerBar.style.backgroundColor = '#dc3545';
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endTurn(true);
                }
            }, 1000);
        }

        function startTurn() {
            gameActive = true;
            currentTurn++;
            currentTurnSpan.textContent = currentTurn;
            renderSymbolRow();
            startTimer();
            startButton.classList.add('hidden');
            nextTurnButton.classList.remove('hidden');
            Array.from(symbolRow.children).forEach(s => {
                s.classList.remove('correct', 'incorrect', 'selected');
            });
        }

        function endTurn(autoAdvance = false) {
            gameActive = false;
            clearInterval(timerInterval);
            evaluateTurn();

            Array.from(symbolRow.children).forEach(s => {
                s.removeEventListener('click', handleSymbolClick);
            });


            if (currentTurn < totalTurns) {
                if (!autoAdvance) {
                    startTurn();
                } else {
                    setTimeout(startTurn, 1000);
                }
            } else {
                displayResults();
            }
        }

        function evaluateTurn() {
            const symbolsInRow = Array.from(symbolRow.children);

            let correctInTurn = 0;
            let incorrectInTurn = 0;
            let omissionsInTurn = 0;

            symbolsInRow.forEach((symbolDiv, index) => {
                const isTarget = symbolDiv.dataset.isTarget === 'true';
                const isSelected = turnSelections.has(index);

                if (isTarget && isSelected) {
                    symbolDiv.classList.add('correct');
                    correctInTurn++;
                } else if (isTarget && !isSelected) {
                    symbolDiv.classList.add('incorrect');
                    omissionsInTurn++;
                } else if (!isTarget && isSelected) {
                    symbolDiv.classList.add('incorrect');
                    incorrectInTurn++;
                }
            });

            totalCorrectSelections += correctInTurn;
            totalIncorrectSelections += incorrectInTurn;
            totalOmissions += omissionsInTurn;
        }

        function displayResults() {
            gameArea.classList.add('hidden');
            gameInfo.classList.add('hidden');
            nextTurnButton.classList.add('hidden');
            resultsPanel.classList.remove('hidden');

            const totalPossibleTargets = totalCorrectSelections + totalOmissions;
            let accuracy = 0;
            if (totalPossibleTargets > 0) {
                accuracy = (totalCorrectSelections / totalPossibleTargets) * 100;
            }

            totalCorrectSpan.textContent = totalCorrectSelections;
            totalIncorrectSpan.textContent = totalIncorrectSelections;
            totalOmissionsSpan.textContent = totalOmissions;
            accuracyScoreSpan.textContent = accuracy.toFixed(2);
        }

        startButton.addEventListener('click', () => {
            totalTurns = parseInt(numTurnsInput.value);
            if (isNaN(totalTurns) || totalTurns <= 0) {
                alert('Ange ett giltigt antal omgångar (minst 1).');
                return;
            }

            instructionsPanel.classList.add('hidden');
            turnConfigDiv.classList.add('hidden');
            gameArea.classList.remove('hidden');
            gameInfo.classList.remove('hidden');
            totalTurnsSpan.textContent = totalTurns;
            startTurn();
        });

        nextTurnButton.addEventListener('click', () => endTurn(false));

        nextTurnButton.classList.add('hidden');
    </script>
</body>

</html>